FROM ubuntu:22.04

SHELL ["/bin/bash", "-c"]
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# System + runtime deps
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates curl wget \
      cmake make git gcc g++ binutils build-essential pkg-config \
      libmpfr-dev libssl-dev libcurl4-openssl-dev libfftw3-dev \
      python3 python3-pip python3-dev python3-setuptools python3-venv \
      libstdc++6 libgomp1 libtbb2 && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# SLEEF build
RUN set -eux; \
    rm -rf /tmp/sleef* /tmp/sleef.tar.gz; \
    curl -L -o /tmp/sleef.tar.gz https://github.com/shibatch/sleef/archive/refs/tags/3.9.0.tar.gz; \
    tar -xzf /tmp/sleef.tar.gz -C /tmp; \
    cmake -S /tmp/sleef-3.9.0 -B /tmp/sleef-3.9.0/build \
      -DCMAKE_INSTALL_PREFIX=/usr/local \
      -DBUILD_SHARED_LIBS=TRUE \
      -DSLEEF_BUILD_GNUABI_LIBS=TRUE; \
    cmake --build /tmp/sleef-3.9.0/build --clean-first -j "$(nproc)"; \
    cmake --install /tmp/sleef-3.9.0/build; \
    ldconfig

# Virtual env setup
ENV VENV=/.venv
RUN python3 -m venv $VENV
ENV PATH="$VENV/bin:$PATH"

# Python deps
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install \
      numpy psutil opencv-python-headless fastapi uvicorn requests

# PyTorch
RUN python3 -m pip install \
      torch==2.9.1+cpu \
      torchvision==0.24.1+cpu \
      torchaudio==2.9.1+cpu \
      --index-url https://download.pytorch.org/whl/cpu

# vAccel
RUN wget https://s3.nbfc.io/nbfc-assets/github/vaccel/rev/main/x86_64/release/vaccel_latest_amd64.deb && \
    wget https://s3.nbfc.io/nbfc-assets/github/vaccel/plugins/rpc/rev/main/x86_64/release/vaccel-rpc_latest_amd64.deb && \
    dpkg -i vaccel_latest_amd64.deb vaccel-rpc_latest_amd64.deb && \
    python3 -m pip install --force-reinstall git+https://github.com/nubificus/vaccel-python

ENV VACCEL_PLUGINS=libvaccel-exec.so:libvaccel-rpc.so
ENV TTRPC_TCP_NODELAY_ENABLED=1

WORKDIR /src
