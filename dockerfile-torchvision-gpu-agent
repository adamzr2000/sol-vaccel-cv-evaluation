FROM nvidia/cuda:12.8.1-runtime-ubuntu22.04

SHELL ["/bin/bash", "-c"]
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# System deps
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates curl wget \
      cmake make git gcc g++ binutils build-essential pkg-config \
      libmpfr-dev libssl-dev libcurl4-openssl-dev libfftw3-dev \
      python3 python3-pip python3-dev python3-setuptools python3-venv \
      libstdc++6 libgomp1 libtbb2 \
      libgl1 libglib2.0-0 file && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# SLEEF build
RUN set -eux; \
    rm -rf /tmp/sleef* /tmp/sleef.tar.gz; \
    curl -L -o /tmp/sleef.tar.gz https://github.com/shibatch/sleef/archive/refs/tags/3.9.0.tar.gz; \
    tar -xzf /tmp/sleef.tar.gz -C /tmp; \
    cmake -S /tmp/sleef-3.9.0 -B /tmp/sleef-3.9.0/build \
      -DCMAKE_INSTALL_PREFIX=/usr/local \
      -DBUILD_SHARED_LIBS=TRUE \
      -DSLEEF_BUILD_GNUABI_LIBS=TRUE; \
    cmake --build /tmp/sleef-3.9.0/build --clean-first -j "$(nproc)"; \
    cmake --install /tmp/sleef-3.9.0/build; \
    ldconfig

# Virtual env setup
ENV VENV=/.venv
RUN python3 -m venv $VENV
ENV PATH="$VENV/bin:$PATH"

# Workaround for sol_mobilenet_v3_large
RUN python3 -m pip install --force-reinstall --no-deps \
    nvidia-cudnn-cu12==9.1.1.17

ENV LD_LIBRARY_PATH="/.venv/lib/python3.10/site-packages/nvidia/cudnn/lib"

# vAccel
RUN wget https://s3.nbfc.io/nbfc-assets/github/vaccel/rev/main/x86_64/release/vaccel_latest_amd64.deb && \
    wget https://s3.nbfc.io/nbfc-assets/github/vaccel/rust/rev/main/x86_64/release/vaccel-rpc-agent_latest_amd64.deb && \
    dpkg -i vaccel_latest_amd64.deb vaccel-rpc-agent_latest_amd64.deb

ENV VACCEL_PLUGINS=libvaccel-exec.so
ENV VACCEL_LOG_LEVEL=3
ENV VACCEL_EXEC_DLCLOSE_ENABLED=0
ENV TTRPC_TCP_NODELAY_ENABLED=1

ENTRYPOINT ["/usr/bin/vaccel-rpc-agent", "-a", "tcp://0.0.0.0:9125"]
