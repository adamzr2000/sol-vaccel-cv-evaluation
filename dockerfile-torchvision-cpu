FROM ubuntu:22.04

SHELL ["/bin/bash", "-c"]
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# System deps + SLEEF build + runtime deps
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      ca-certificates curl \
      cmake make git gcc g++ \
      libmpfr-dev libssl-dev libfftw3-dev \
      python3 python3-pip \
      libstdc++6 libgomp1 libsleef3 libtbb2 \
      binutils \
    ; \
    curl -L -o /tmp/sleef.tar.gz https://github.com/shibatch/sleef/archive/refs/tags/3.9.0.tar.gz; \
    tar -xzf /tmp/sleef.tar.gz -C /tmp; \
    cmake -S /tmp/sleef-3.9.0 -B /tmp/sleef-3.9.0/build \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DBUILD_SHARED_LIBS=TRUE \
      -DSLEEF_BUILD_GNUABI_LIBS=TRUE; \
    cmake --build /tmp/sleef-3.9.0/build --clean-first -j "$(nproc)"; \
    cmake --install /tmp/sleef-3.9.0/build; \
    rm -rf /tmp/sleef* /tmp/sleef.tar.gz; \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*

# Python deps
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install \
      numpy psutil opencv-python-headless fastapi uvicorn

# PyTorch
RUN python3 -m pip install \
      torch==2.9.1+cpu \
      torchvision==0.24.1+cpu \
      torchaudio==2.9.1+cpu \
      --index-url https://download.pytorch.org/whl/cpu

WORKDIR /src
